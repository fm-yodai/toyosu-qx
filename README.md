# Toyosu-QX（豊洲QX）

豊洲市場における「ターレ運用最適化シミュレーションプラットフォーム」

## 概要

豊洲市場では、仲卸から小売への構内配送をターレ（小型配送車両）で行っていますが、少量個別発車による積載率低下・待機時間の増大・総走行距離の増大が課題となっています。

**Toyosu-QX**は、離散事象シミュレーション（DES: Discrete Event Simulation）を用いてターレ運用を可視化・定量化し、将来的にはリアルタイム最適化による「ターレ共同運送プラットフォーム」の実現を目指すプロジェクトです。

### プロジェクトフェーズ

- **Phase 1（現在）**: 1秒粒度DES + ルールベース配車 + 2D可視化 + KPIダッシュボード
- **Phase 2（将来）**: 10秒ごとの最適化ティック + OR-Tools/量子最適化エンジン統合

## 主要機能

- **1秒粒度の離散事象シミュレーション**: 積込・出発/到着・荷下ろし・取引確定などの主要イベントを秒単位で再現
- **KPI計測**:
  - ターレ側：稼働率、稼働時間、走行距離、1便平均積載率
  - 小売側：リードタイム分布（平均・95%点）、充足率、分割納品率
  - 仲卸側：販売消化率、待機在庫時間、タスク待ち行列長
- **可視化**: Plotlyによる2Dアニメーション再生、時系列ダッシュボード、ヒートマップ、サンキー図
- **再現性保証**: シード制御・設定ハッシュ・メタデータログによる完全な実験再現

## 技術スタック

- **言語**: Python 3.12+（型ヒント必須、mypy strict mode）
- **シミュレーションエンジン**: [SimPy](https://simpy.readthedocs.io/) - 離散事象シミュレーションフレームワーク
- **可視化**: [Plotly](https://plotly.com/python/)（インタラクティブ）/ Matplotlib（静的出力）
- **データ処理**: Polars/Pandas（KPI集計）、Parquet（時系列ストレージ）
- **設定管理**: YAML（シナリオ定義）、JSON（スナップショット）
- **パッケージ管理**: [uv](https://docs.astral.sh/uv/)

## セットアップ

### 前提条件

- Python 3.12 以上
- [uv](https://docs.astral.sh/uv/) パッケージマネージャ

### インストール

```bash
# リポジトリのクローン
git clone <repository-url>
cd toyosu-qx

# 依存関係のインストール
uv sync
```

## 使用方法

### 基本実行

```bash
# メインシミュレーションの実行
python main.py
```

### シナリオ指定実行

```bash
# 通常実行（レポート自動生成）
python run.py \
  --scenario config/scenario/default.yaml \
  --config config/config.yaml \
  --seed 42

# レポート生成をスキップ
python run.py --scenario config/scenario/default.yaml --no-report
```

### 出力ファイル

シミュレーション実行後、`data/runs/{run_id}/` 以下に以下のファイルが生成されます：

**データファイル:**
- `events.parquet`: 秒粒度のイベントログ（タイムスタンプ、車両ID、ノード、イベント種別、状態、積載量など）
- `kpi.parquet`: KPI集計結果（稼働率、距離、リードタイムなど）
- `meta.jsonl`: 実行メタデータ（run_id、コマンドライン引数、config_hash、開始/終了時刻）

**可視化レポート（HTML）:**
- `report.html`: 全ての可視化を含む統合レポート
- `dashboard.html`: KPIダッシュボード（稼働率、距離、リードタイムなど）
- `heatmap_demand.html`: 時間帯別需要ヒートマップ
- `heatmap_utilization.html`: ターレ稼働状態ヒートマップ
- `sankey_2layer.html`: 2層配送フロー（仲卸→小売）
- `sankey_3layer.html`: 3層配送フロー（仲卸→ターレ→小売）
- `animation_tares.html`: ターレ移動のアニメーション

### レポート再生成

既存のシミュレーション結果からレポートを生成：

```bash
python generate_report.py 2025-11-11_084402Z --scenario config/scenario/default.yaml
```

### 可視化の種類

- **KPIダッシュボード**: 稼働率推移、累積走行距離、リードタイム分布、時間帯別配送数
- **需要ヒートマップ**: 時間帯×仲卸の需要パターン
- **稼働状態ヒートマップ**: ターレごとの時系列稼働状態（待機/積込/移動/荷下ろし）
- **サンキー図**: 配送フローの可視化（仲卸→小売、仲卸→ターレ→小売）
- **アニメーション**: ターレの2D移動を時系列で再生

詳細は [可視化ガイド](docs/visualization.md) を参照してください。

## プロジェクト構成（計画）

```
toyosu-qx/
├── run.py                  # エントリポイント
├── main.py                 # 現在の実行ファイル
├── sim/                    # シミュレーションコア
│   ├── engine.py          # SimPyイベントループ・リソース管理
│   ├── planner_rule.py    # ルールベース配車ロジック
│   ├── demand.py          # 需要生成
│   ├── kpi.py             # KPI集計
│   └── models.py          # データクラス（Tare, Order, Node）
├── config/                 # 設定ファイル
│   ├── config.yaml        # α/β係数、速度、出発トリガ、混載方針
│   └── scenario/          # シナリオ定義
│       └── default.yaml   # 需要曲線、仲卸/小売規模、稼働時間窓
├── data/                   # データ・実行結果
│   └── runs/              # 実行ごとの出力（run_id別）
├── docs/                   # ドキュメント
│   ├── project-constitution.md  # プロジェクト憲章
│   ├── glossary.md              # 用語集
│   └── architecture_python.md   # アーキテクチャ設計
└── notebooks/              # 分析ノートブック（Phase 2）
```

## 重要な設計原則

プロジェクトは`.specify/memory/constitution.md`に定義された5つの核心原則に基づいています：

1. **シミュレーション忠実性・再現性**: シード制御・設定スナップショットによる完全再現
2. **イベント駆動アーキテクチャ（必須）**: SimPyイベントパラダイムの厳守
3. **方針と機構の分離**: Planner（配車ロジック）とCore（シミュレーション）の分離
4. **計測ファーストデザイン**: 実装前のKPI定義と検証シナリオ
5. **シンプルさ・段階的拡張**: Phase 1は最小モデル、複雑化はPhase 2で正当化

## 主要パラメータ（初期値）

| パラメータ | 値 | 説明 |
|-----------|------|------|
| 最高積載量 | 200 kg | ターレ1台あたりの最大積載容量 |
| 平均速度 | 8 km/h | 市場内走行速度 |
| 積込時間 | α=0.3 s/kg, β=10 s | t = α·W + β |
| 荷下ろし時間 | α=0.3 s/kg, β=10 s | t = α·W + β |
| 取引処理時間 | 30秒 | 伝票処理等 |
| 5分ルール | 300秒 | 追加積込がない場合の出発トリガ |
| 稼働時間 | 4:00–12:00 | 8時間（例） |
| 口割 | 10/30/50 kg | 小口・中口・大口 |

## 開発ワークフロー

1. **Phase 0（調査）**: 文献調査、アルゴリズム選定、インターフェース設計 → `specs/{feature}/research.md`
2. **Phase 1（設計）**: データモデル、API契約、KPI定義 → `data-model.md`, `contracts/`
3. **Phase 2（実装）**: 憲法準拠チェック付き反復開発
4. **Phase 3（検証）**: KPI整合性テスト、シナリオ再生検証、パフォーマンスプロファイリング

## 簡略化・仮定

Phase 1では以下を簡略化しています（Phase 2で拡張予定）：

- 渋滞・故障・破損・駐車制約は未考慮
- 速度は一定（8 km/h）
- 同一宛先混載のみ（複数宛先の積み合わせは未実装）
- 線形時間モデル：積込/荷下ろし時間 = α·重量 + β

## KPI定義

### ターレ側
- **稼働率**: 積載走行時間 / 総稼働時間
- **稼働時間**: 最初の出発から最後の荷下ろしまで
- **走行距離**: 総走行距離（km）
- **平均積載率**: 平均積載重量 / 200kg

### 小売側
- **リードタイム分布**: 注文確定から納品完了までの時間（平均・95パーセンタイル）
- **充足率**: 納品完了注文数 / 総注文数
- **分割納品率**: 複数便に分割された注文の割合

### 仲卸側
- **販売消化率**: 出荷完了 / 販売確定
- **待機在庫時間**: 出荷待ちの平均待機時間
- **タスク待ち行列長**: ピーク時の未割当タスク数

## ライセンス

（ライセンス情報を追加してください）

## 貢献

Issue・Pull Requestを歓迎します。大きな変更の場合は、まずIssueで議論してください。

## 関連ドキュメント

### プロジェクト全体
- [プロジェクト憲章](docs/project-constitution.md): 背景・目的・KPI・スコープ・マイルストーン
- [用語集](docs/glossary.md): ドメイン用語（日本語）の定義
- [アーキテクチャ設計](docs/architecture_python.md): 技術アーキテクチャ詳細
- [CLAUDE.md](CLAUDE.md): AI開発アシスタント向けガイダンス
- [Constitution](.specify/memory/constitution.md): プロジェクトガバナンス原則

### 可視化・分析
- [可視化ガイド](docs/visualization.md): レポート生成と使い方
- [Plotly使い方](docs/plotly/README.md): グラフ作成の詳細
  - [アニメーション](docs/plotly/animations.md)
  - [サンキー図](docs/plotly/sankey.md)
  - [ヒートマップ](docs/plotly/heatmaps.md)
  - [時系列グラフ](docs/plotly/timeseries.md)
- [Marimo使い方](docs/marimo/README.md): インタラクティブ分析（Phase 2）
